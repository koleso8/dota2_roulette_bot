import { Telegraf } from 'telegraf';
import dotenv from 'dotenv';
dotenv.config();

const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
if (!BOT_TOKEN) {
    throw new Error('TELEGRAM_BOT_TOKEN is not set');
}

const bot = new Telegraf(BOT_TOKEN);

// ÐšÐ½Ð¾Ð¿ÐºÐ° Ð´Ð»Ñ WebApp (Ð¾Ñ‚ÐºÑ€Ð¾ÐµÑ‚ Ð²Ð°ÑˆÑƒ Ð¸Ð³Ñ€Ñƒ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Telegram)
bot.command('play', (ctx) => {
    ctx.reply('ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ', {
        reply_markup: {
            inline_keyboard: [
                [{ text: 'ðŸŽ® Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ', web_app: { url: 'https://dota2-roulette.vercel.app/' } }]
            ]
        }
    });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ ÑÑ‚Ð°Ñ€Ñ‚
bot.start((ctx) => {
    ctx.reply(
        'Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! ðŸŽ‰\n\n' +
        'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n' +
        '/play - Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· inline ÐºÐ½Ð¾Ð¿ÐºÑƒ (Ñ initData)\n' +
        '/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ'
    );
});

// ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ
bot.help((ctx) => {
    ctx.reply(
        'Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n' +
        '/play - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ\n' +
        '/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾\n\n' +
        'Ð”Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /play'
    );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚ WebApp
bot.on('web_app_data', (ctx) => {
    console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚ WebApp:', ctx.webAppData);
    const data = JSON.parse(ctx.webAppData.data);

    ctx.reply(
        `ðŸŽ‰ Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¸Ð³Ñ€Ñƒ!\n\n` +
        `ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ${JSON.stringify(data, null, 2)}`,
        {
            reply_markup: {
                inline_keyboard: [
                    [{ text: 'ðŸ”„ Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ ÑÐ½Ð¾Ð²Ð°', web_app: { url: 'https://dota2-roulette.vercel.app/' } }]
                ]
            }
        }
    );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => {
    if (ctx.message.text === 'âŒ Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ') {
        ctx.reply('ÐšÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ð° ÑÐºÑ€Ñ‹Ñ‚Ð°', {
            reply_markup: { remove_keyboard: true }
        });
    } else if (!ctx.message.text.startsWith('/')) {
        ctx.reply('Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /play Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ!');
    }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð±Ð¾Ñ‚Ð°:', err);
    ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.');
});

bot.launch();

console.log('Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));